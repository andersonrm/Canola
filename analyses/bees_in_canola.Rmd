---
title: "Canola Bee Analysis"
author: "Dr. Riley M. Anderson, Olivia Shaffer, & Salena Helmreich"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
graphics: yes
output:
  github_document:
    toc: yes
    toc_depth: 5
    pandoc_args: --webtex
  html_document:
    keep_md: yes
    theme: readable
    mathjax: default
  html_notebook:
    code_folding: hide
    theme: readable
    mathjax: default
  pdf_document:
    toc: yes
header-includes:
  \usepackage{float}
  \floatplacement{figure}{H}
editor_options:
  chunk_output_type: console
---

```{r setup, include = F}
# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
# @@@@@ Knitr Options
# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

# Set root directory to the project directory
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())


# Set default knitr options: 
# Suppress warnings and messages, cache chunks, 
#  set default figure size to 6x8 at 300 dpi, and save a png and pdf
knitr::opts_chunk$set(warning = F, message = F, collapse = T, cache = T,
    fig.height = 6, fig.width = 8, dpi = 300, # 6x8" @ 300dpi:1800x2400=4.3MP
    dev = c('png', 'pdf'), dev.args = list(pdf = list(onefile = F)))

```



## Overview

This analysis explores Salena and Olivia's canola experiment.

### Summary of Results

* No difference in bee community composition across habitat types (natural or semi-natural), or habitat types and bloom period.

```{r Main_Code, include = F, cache = F}

# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
# @@@@@ Setup - This code is run, but output is hidden
# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

# Load Packages
library(tidyverse)
library(cowplot) 
library(glmmTMB)
library(lme4)
library(sjPlot)
library(knitr)
library(emmeans)
library(vegan)
library(randomForest)
library(caret)
library(adespatial)
library(ggrepel)
library(ggeffects)
library(gamm4)

# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
# @@@@@ Data Preparation
# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

# Import datasets
bees <- read.csv("data/Bee_Samples_2022.csv")

plants <- read.csv("data/PlantDiv2022.csv")

bee_hw <- read.csv("data/CleanPalouseBees.csv")

canola <- read.csv("data/canola_coverage.csv")

canola_bees <- read.csv("data/bees_in_canola.csv")

canola_buffs <- read.csv("data/Canola_Buffs.csv")

###### Functions


```


```{r Data_Wrangling, echo = F, comment = ""}

# clean up Salena's data:
bee_hw <- bee_hw %>% 
  mutate(across(
    c(period : land_type), factor),
    across(c(transect : genus), factor),
    date = ymd(date),
    year = as.numeric(year(date)) + 2000,
    month = as.numeric(month(date)),
    day = as.numeric(day(date)),
    date = paste(year, month, day, sep = "_"),
    date = ymd(date),
    site = factor(case_when(
      site == "Smoot " ~ "Smoot",
      TRUE ~ site)),
    period = factor(case_when(
      period == "1" ~ "Pre-Bloom",
      period == "2" ~ "Peak-Bloom",
      TRUE ~ "Post-Bloom")),
    in_canola = factor("no"))


hw_1 <- bee_hw %>% 
  select(date, period, site, land_type, latitude, longitude,
         transect, morphogroup, family, genus, head_width,
         intertegular_space, in_canola)

canola_bees <- canola_bees %>% 
  filter(!is.na(ID),
         Genus != "Wasp",
           Genus != "") %>% 
  mutate(across(c(
    Site : sex, County : Catch), factor)) %>% 
  unite(new_date, c(Year, Month, Day), sep = "-") %>% 
  mutate(date = ymd(new_date),
         Period = factor(case_when(
      Period == "2" ~ "Peak-Bloom",
      Period == "3" ~ "Post-Bloom",
      TRUE ~ NA)),
      land_type = factor("canola"),
      in_canola = factor("yes"),
      HW = as.numeric(HW)) %>% 
  select(-Date) %>% 
  rename(site = Site,
         period = Period,
         transect = Transect,
         genus = Genus,
         species = Species,
         head_width = HW,
         latitude = Lat,
         longitude = Long,
         subgenus = Subgenus)

hw_2 <- canola_bees %>% 
  select(date, period, site, land_type, latitude, longitude,
         transect, genus, subgenus, species, head_width,
         land_type, in_canola)

bee_head_width <- bind_rows(hw_1, hw_2)


#{{{{{{{{{{{{}}}}}}}}}}}}
# plant data:
plants <- plants %>% 
  filter(Genus != "UK") %>% 
  mutate(Date = mdy(Date),
         across(c(Period : Species), factor),
         Period = factor(case_when(
           Period == "PreBloom" ~ "Pre-Bloom",
           Period == "PeakBloom" ~ "Peak-Bloom",
           Period == "DeclineBloom" ~ "Post-Bloom",
           TRUE ~ NA)),
         Site = factor(case_when(
           Site == "TurnbullPlaza" ~ "Plaza",
           Site == "TurnbullSpangle" ~ "Spangle",
           TRUE ~ Site)),
         siteID = factor(paste(Site, Period, sep = "_")),
         FloralUnits = case_when(
           is.na(FloralUnits) ~ 0,
           TRUE ~ FloralUnits),
         DoY = yday(Date),
         DoY = case_when(
           DoY == 153 & Site == "Chipman1" ~ 151,
           DoY == 153 & Site == "Chipman2" ~ 151,
           TRUE ~ DoY)) %>% 
  unite(spp, c(Genus, Species), sep = " ", remove = F) %>% 
  rename(date = Date,
         period = Period,
         site = Site,
         transect = Transect,
         family = Family,
         genus = Genus,
         species = Species)

canola_plants <- data.frame(
  site = factor(levels(canola_bees$site)),
  CommonName = factor("canola"),
  Amount = 100,
  FloralUnits = 100)


plants <- bind_rows(plants, canola_plants)

#########################

# Site data
canola <- canola %>% 
  mutate(site = factor(site),
         PrairieFragment = factor(PrairieFragment),
         PrairieFragment = factor(case_when(
           site == "Asotin" | site == "Hutchins" ~ "No",
           site == "Plaza" | site == "Spangle" ~ "Yes",
           TRUE ~ PrairieFragment
         )))

canola_sites <- bee_head_width %>%
  filter(in_canola == "yes") %>%
  select(site, latitude, longitude) %>%
  distinct() %>%
  mutate(lat_long = paste(latitude,longitude, sep = ",")) %>% 
  filter(!is.na(latitude))

site_data <- canola_buffs %>% 
  mutate(propCan500m = Canola_area500m / total_area500m,
         propCan1km = Canola_area1000m / total_area1000m,
         propCan2km = Canola_area2000m / total_area2000m,
         site = factor(site),
         DistanceToCanola = 1,
         PrairieFragment = factor("No")) %>% 
  select(site, propCan500m, propCan1km, propCan2km,
         DistanceToCanola, PrairieFragment) %>% 
  bind_rows(., canola)

```


```{r plant_community_wrangling, echo = F}

plant_matrix <- plants %>% 
  uncount(Amount) %>% 
  select(site, CommonName) %>% 
  group_by(site, CommonName) %>% 
  tally() %>% 
  pivot_wider(names_from = CommonName,
              values_from = n,
              values_fill = list(n = 0)) %>% 
  column_to_rownames("site")

plant_div <- cbind(
  shannon = diversity(plant_matrix),
  richness = specnumber(plant_matrix),
  pielou = diversity(plant_matrix) / 
    log(specnumber(plant_matrix))) %>%
  as.data.frame() %>% 
  rownames_to_column("site") %>% 
  mutate(site = factor(site))

total_floral <- plants %>%
  group_by(site) %>% 
  summarise(q_floral = sum(FloralUnits))

plant_div <- left_join(plant_div, total_floral,
                       by = "site")

site_data <- left_join(site_data, plant_div, by = "site")  


bee_head_width <- left_join(bee_head_width,
                            site_data, by = "site")


# bees abundant enough for head_width analyses:
five_bees <- bee_head_width %>%
  group_by(genus) %>%
  tally() %>% 
  filter(n >= 5)


ten_bees <- bee_head_width %>%
  group_by(genus) %>%
  tally() %>% 
  filter(n >= 10)

```



```{r eda_figs, echo = F}

# plant div and canola distance:
site_data %>% 
  ggplot(aes(x = DistanceToCanola, y = shannon)) +
  geom_jitter() +
  scale_x_continuous(transform = "log")

# plant div and canola buffer props:
site_data %>% 
  ggplot(aes(x = propCan2km, y = shannon)) +
  geom_point()

# head width and canola props:
bee_head_width %>% 
  ggplot(aes(x = propCan500m, y = head_width,
             color = genus)) +
  geom_point()

```

```{r eda_floral_units, echo = F}

bee_head_width %>% 
  filter(in_canola == "no") %>% 
  ggplot(aes(x = propCan2km, y = q_floral)) +
  geom_point()

```

```{r eda_bee_genera_in_canola, echo = F}

semi_join(bee_head_width, ten_bees, by = "genus") %>% 
  group_by(site, genus, in_canola) %>% 
  tally() %>% 
  ggplot(aes(x = genus, y = n, color = site)) +
  geom_point() +
  facet_wrap(~in_canola) +
  coord_flip()

```


```{r head_width_models, echo = F}




hw_mod1 <- lmer(head_width ~ in_canola * propCan2km +
                  (propCan2km | genus),
                data = semi_join(bee_head_width, ten_bees,
                                 by = "genus"))

# plot_model(hw_mod1, type = "diag")
# plot_model(hw_mod1, type = "est")
plot_model(hw_mod1, type = "re") +
  theme_minimal(base_size = 18) +
  labs(title = "")

summary(hw_mod1)

# plant richness, shannon diversity, and cumulative floral units had no effect on head_width and were removed from the models.

```

```{r head_width_figure, echo = F}

hw_pred <- ggpredict(hw_mod1,
                     terms = c("propCan2km", "in_canola"))



hw_pred_genus <- ggpredict(hw_mod1,
                           terms = c("propCan2km", "in_canola",
                                     "genus"))


hw_pred_genus %>%
  as.data.frame() %>% 
  mutate(in_canola = group) %>% 
  ggplot(aes(x = x, y = predicted, color = in_canola)) +
  geom_line(size = 2, show.legend = F) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high,
                  color = in_canola), alpha = 0,
              linetype = 2, show.legend = F) +
  geom_jitter(data = semi_join(bee_head_width, ten_bees, by = "genus"),
             aes(x = propCan2km, y = head_width,
                 fill = in_canola),
             width = 0.002,
             shape = 21,
             color = "black",
             show.legend = F) +
  theme_minimal(base_size = 18) +
  labs(x = "Canola saturation\n(2km radius)",
       y = "Predicted head width\n(mm)",
       fill = "Canola") +
  scale_color_manual(values = c("no" = "#A1CAF1",
                                "yes" = "#d95f02")) +
  scale_fill_manual(values = c("no" = "#A1CAF1",
                               "yes" = "#d95f02")) 
  
  

```

## Summary stats for head width model
```{r hw_mod_summary, echo = F}

# library(parameters)
# model_parameters(hw_mod1)

# write.csv(model_parameters(hw_mod1),
#           file = "data/hw_mod_summary.csv")
hw_mod1_summary <- read.csv("data/hw_mod_summary.csv")

kable(hw_mod1_summary,
      format = "markdown", digits = 2)



sjPlot::tab_model(hw_mod1,
                  show.ci = TRUE,
                  show.std = TRUE,
                  show.re.var = TRUE,
                  digits = 3)

```

## Mixed-model figure

```{r mixed_effects_fig, echo = F}


re <- ranef(hw_mod1, condVar = TRUE)
slopes <- re$genus %>% 
  as.data.frame() %>%
  rownames_to_column("genus") %>%
  dplyr::select(genus, propCan2km)

vc <- attr(re$genus, "postVar")

slopes$se <- sqrt(sapply(1 : dim(vc)[3], function(i) vc[2, 2, i]))

slopes <- slopes %>%
  mutate(lower = propCan2km - 1.96 * se,
    upper = propCan2km + 1.96 * se)


xpred <- seq(min(bee_head_width$propCan2km),
             max(bee_head_width$propCan2km),
             length.out = 50)

newdat <- expand.grid(
  propCan2km = xpred,
  genus = unique(semi_join(bee_head_width, ten_bees,
                                 by = "genus")$genus),
  in_canola = c("no", "yes"))

newdat$pred <- predict(hw_mod1, newdat, re.form = NULL)


newdat %>% 
  ggplot() +
  geom_line(aes(x = propCan2km, y = pred,
                group = interaction(genus, in_canola)),
            color = "grey70", linewidth = 0.5, alpha = 0.6) +
  geom_line(data = hw_pred,
            aes(x = x, y = predicted, color = group),
            linewidth = 1.4,
            show.legend = F) +
  geom_ribbon(data = hw_pred,
              aes(x = x, ymin = conf.low,
                  ymax = conf.high,
                  color = group),
              alpha = 0, linetype = 2,
              show.legend = F) +
  scale_color_manual(values = c("#A1CAF1", "#d95f02")) +
  labs(x = "Canola saturation\n(2km radius)",
    y = "Predicted head width\n(mm)") +
  theme_minimal(base_size = 18)


```

## Random slopes figure
```{r RE_slopes, echo = F}

slopes <- slopes %>% 
  mutate(Color = factor(case_when(
    lower < 0 & upper > 0 ~ "notsig",
    TRUE ~ "sig"
  )))

slopes %>% 
  ggplot(aes(x = propCan2km, y = genus, color = Color)) +
  geom_point(show.legend = F) +
  geom_errorbar(aes(xmin = lower,
                    xmax = upper),
                width = 0,
                show.legend = F) +
  scale_color_manual(values = c("darkgrey", "black")) +
  theme_minimal(base_size = 18) +
  labs(y = NULL,
       x = "Canola saturation\n(2km radius)") +
  scale_x_continuous(limits = c(-2.5, 2.5)) +
  geom_vline(aes(xintercept = 0))

```

## Bee diversity (PERMANOVA)
```{r bee_diversity, echo = F}

bee_matrix <- bee_head_width %>% 
  group_by(genus, date, site) %>% 
  tally(n = "count") %>% 
  pivot_wider(names_from = genus,
              values_from = count,
              values_fill = list(count = 0)) %>% 
  unite(col = date_site, c(date, site), sep = "_") %>% 
  column_to_rownames("date_site")
  

bee_meta <- bee_head_width %>% 
  select(date, site, in_canola, propCan500m, propCan1km,
         propCan2km, shannon, richness, pielou) %>% 
  distinct() %>% 
  mutate(pielou = case_when(
    pielou == "NaN" ~ 1,
    TRUE ~ pielou),
    date_site = paste(date, site, sep = "_"),
    week = week(date),
    JD = yday(date))


## PERMANOVA
adonis_mod1 <- adonis2(bee_matrix ~ in_canola +
                         JD +
                         splines::ns(propCan2km,
                                     df = 5) +
                         richness +
                         shannon,
        data = bee_meta, method = "bray")

# adonis_mod1

# write.csv(adonis_mod1,
#           file = "data/permanova_summary.csv")

kable(adonis_mod1,
      format = "markdown",
      digits = 2)

permutest(betadisper(vegdist(bee_matrix, method = "bray"),
                     bee_meta$in_canola))


simper_result <- simper(bee_matrix,
                        group = bee_meta$in_canola)
summary(simper_result)

```

# CAP (bee composition by canola)


## In canola or not
```{r bee_comp_canola, echo = F}


canola_diss <- vegdist(bee_matrix, method = "bray")

cap_model1 <- capscale(bee_matrix ~ in_canola,
                      data = bee_meta,
                      distance = "bray")

summary(cap_model1)

site_scores <- scores(cap_model1, display = "sites") %>%
  as.data.frame() %>%
  mutate(sample = rownames(.),
         in_canola = bee_meta$in_canola,
         propCan2km = bee_meta$propCan2km,
         richness = bee_meta$richness)

species_scores <- scores(cap_model1, display = "species") %>%
  as.data.frame() %>%
  rownames_to_column("species")

# Optional: keep only species with strongest loadings on CAP1
species_scores_filtered <- species_scores %>%
  filter(abs(CAP1) > 0.1 | abs(MDS1) > 0.1)


ggplot(site_scores,
       aes(x = CAP1, y = MDS1,
           color = in_canola, fill = in_canola)) +
  stat_ellipse(geom = "polygon", type = "t",
               level = 0.95, alpha = 0.3) +
  geom_point(size = 2.5, shape = 21, stroke = 0.5,
             aes(fill = in_canola), color = 'black') +
  scale_color_manual(values = c("no" = "#A1CAF1",
                                "yes" = "#d95f02")) +
  scale_fill_manual(values = c("no" = "#A1CAF1",
                               "yes" = "#d95f02")) +
  geom_segment(data = species_scores_filtered,
               aes(x = 0, y = 0, xend = CAP1, yend = MDS1),
               arrow = arrow(length = unit(0.2, "cm")),
               color = "black",
               inherit.aes = F) +
  geom_text(data = species_scores_filtered,
            aes(x = CAP1 * 1.1, y = MDS1 * 1.1, label = species),
            size = 3, hjust = 0.5,
            inherit.aes = F) +
  theme_minimal(base_size = 14) +
  labs(
    x = "CAP1 (Canola--10%)",
    y = "MDS1 (Residual--77%)",
    fill = "Canola", color = "Canola"
  )


```

## Proportion canola
```{r bee_comp_canola_prop_Can, echo = F}

gam_cap <- gamm4(propCan2km ~ s(CAP1, MDS1, k = 5),
                 data = site_scores)

grid_cap <- expand.grid(CAP1 = seq(min(site_scores$CAP1),
                                   max(site_scores$CAP1),
                                   length = 100),
                        MDS1 = seq(min(site_scores$MDS1),
                                   max(site_scores$MDS1),
                                   length = 100))

grid_cap$propCan2km <- predict(gam_cap$gam, newdata = grid_cap)


ggplot(site_scores,
       aes(x = CAP1, y = MDS1,
           color = in_canola, fill = in_canola)) +
  geom_point(shape = 21, size = 2, stroke = 0.5,
             aes(fill = in_canola), color = 'black') +
  stat_ellipse(geom = "polygon", type = "t",
               level = 0.95, alpha = 0.3) +
  geom_contour(data = grid_cap,
               aes(x = CAP1, y = MDS1, z = propCan2km),
               color = "grey40", inherit.aes = FALSE) +
  metR::geom_text_contour(data = grid_cap,
                          aes(x = CAP1, y = MDS1, z = propCan2km),
                          color = "grey20", stroke = 0.2, skip = 1,
                          inherit.aes = FALSE) +
  scale_color_manual(values = c("no" = "#A1CAF1",
                                "yes" = "#d95f02")) +
  scale_fill_manual(values = c("no" = "#A1CAF1",
                               "yes" = "#d95f02")) +
  theme_minimal(base_size = 14) +
  labs(x = "CAP1 (Canola--10%)",
       y = "MDS1 (Residual--17%)",
       fill = "Canola", color = "Canola") +
  geom_segment(data = species_scores_filtered,
               aes(x = 0, y = 0, xend = CAP1, yend = MDS1),
               arrow = arrow(length = unit(0.2, "cm")),
               color = "black",
               inherit.aes = F) +
  geom_text(data = species_scores_filtered,
            aes(x = CAP1 * 1.1, y = MDS1 * 1.1, label = species),
            size = 3, hjust = 0.5,
            inherit.aes = F)

```


## Plant richness
```{r bee_comp_canola_richness, echo = F}

gam_cap2 <- gamm4(richness ~ s(CAP1, MDS1, k = 5),
                 data = site_scores)

grid_cap$richness <- predict(gam_cap2$gam, newdata = grid_cap)


ggplot(site_scores,
       aes(x = CAP1, y = MDS1,
           color = in_canola, fill = in_canola)) +
  geom_point(shape = 21, size = 2, stroke = 0.5,
             aes(fill = in_canola), color = 'black') +
  stat_ellipse(geom = "polygon", type = "t",
               level = 0.95, alpha = 0.3) +
  geom_contour(data = grid_cap,
               aes(x = CAP1, y = MDS1, z = richness),
               color = "grey40", inherit.aes = FALSE) +
  metR::geom_text_contour(data = grid_cap,
                          aes(x = CAP1, y = MDS1, z = richness),
                          color = "grey20", stroke = 0.2, skip = 1,
                          inherit.aes = FALSE) +
  scale_color_manual(values = c("no" = "#A1CAF1",
                                "yes" = "#d95f02")) +
  scale_fill_manual(values = c("no" = "#A1CAF1",
                               "yes" = "#d95f02")) +
  theme_minimal(base_size = 14) +
  labs(x = "CAP1 (Canola--10%)",
       y = "MDS1 (Residual--17%)",
       fill = "Canola", color = "Canola") +
  geom_segment(data = species_scores_filtered,
               aes(x = 0, y = 0, xend = CAP1, yend = MDS1),
               arrow = arrow(length = unit(0.2, "cm")),
               color = "black",
               inherit.aes = F) +
  geom_text(data = species_scores_filtered,
            aes(x = CAP1 * 1.1, y = MDS1 * 1.1, label = species),
            size = 3, hjust = 0.5,
            inherit.aes = F)

```


```{r bee_rich_canola, echo = F}

bee_div <- cbind(
  bee_shannon = diversity(bee_matrix),
  bee_richness = specnumber(bee_matrix),
  bee_pielou = diversity(bee_matrix) / 
    log(specnumber(bee_matrix))) %>% 
  as.data.frame() %>% 
  rownames_to_column("date_site") %>% 
  mutate(in_canola = bee_meta$in_canola,
         propCan2km = bee_meta$propCan2km,
         propCan1km = bee_meta$propCan1km,
         propCan500m = bee_meta$propCan500m,
         shannon = bee_meta$shannon,
         richness = bee_meta$richness,
         pielou = bee_meta$pielou,
         JD = bee_meta$JD)


bee_div %>% 
  ggplot(aes(x = propCan2km, y = bee_shannon,
             color = in_canola)) +
  geom_point()

```


## Session Information

```{r Session_Info, echo = F, comment = ""}

# Add session information to help with reproduceability
sessionInfo()


```


